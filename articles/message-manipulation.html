<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Manipulating Harp Messages </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Manipulating Harp Messages ">
      
      <link rel="icon" href="../favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/harp-tech/harp-tech.github.io/blob/main/articles\message-manipulation.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="manipulating-harp-messages">Manipulating Harp Messages</h1>

<p>This section covers advanced message manipulation techniques that allow destructuring and constructing Harp messages at will from their essential elements. It is useful mostly for applications where routing of Harp messages is dynamic, when we need to build new commands based on previous responses, or when manipulating timestamped sequences for reactive computations that require keeping the original hardware timestamp of the result.</p>
<h2 id="modifying-message-fields">Modifying message fields</h2>
<p>We discussed how to generate <a class="xref" href="../api/Bonsai.Harp.HarpMessage.html"><code>HarpMessage</code></a> objects by using either the <a class="xref" href="../api/Bonsai.Harp.CreateMessage.html"><code>CreateMessage</code></a> operator or by using <a class="xref" href="../api/Bonsai.Harp.Format.html"><code>Format</code></a> with compatible data types. However, in specific cases, we might want to take a given <code>HarpMessage</code> and simply change the value of one or more of its metadata fields, for example its <code>Address</code>.</p>
<p>We could, in theory, <a class="xref" href="../api/Bonsai.Harp.Parse.html"><code>Parse</code></a> the incoming message into its components and &quot;reassemble&quot; everything with one of the constructor operators, but in practice this tends to be too cumbersome and inefficient.</p>
<p>Another option is to use a specific overload of the <a class="xref" href="../api/Bonsai.Harp.Format.html"><code>Format</code></a> operator that accepts a sequence of <code>HarpMessage</code> objects as input. In this case we can replace the value of one or more of its metadata fields by specifying non-null values in the operator properties.</p>
<p>For instance, to change the <code>Address</code> of a <code>HarpMessage</code>:</p>
<div class="workflow"><p><img src="../workflows/modify-message-address.bonsai" alt="ModifyHarpMessageAddress"></p>
</div>
<div class="NOTE">
<h5>Note</h5>
<p>These overloads are only available when the <code>Register</code> property of the <a class="xref" href="../api/Bonsai.Harp.Format.html"><code>Parse</code></a> operator is set to <a class="xref" href="../api/Bonsai.Harp.FormatMessagePayload.html"><code>FormatMessagePayload</code></a>.</p>
</div>
<h2 id="injecting-or-modifying-message-timestamps">Injecting or modifying message timestamps</h2>
<p>The <a class="xref" href="../api/Bonsai.Harp.Format.html"><code>Format</code></a> operator also allows us to inject or modify a timestamp of a <code>HarpMessage</code> object. This is done by providing an input of type <a class="xref" href="../api/Bonsai.Harp.Timestamped-1.html"><code>Timestamped&lt;T&gt;</code></a>, where <code>T</code> in this case would be of type <code>HarpMessage</code>. For instance, to set the timestamp of a given message to <code>0</code>:</p>
<div class="workflow"><p><img src="../workflows/modify-message-double-timestamp.bonsai" alt="ModifyHarpMessageTimestampFromDouble"></p>
</div>
<p>Alternatively, it is also possible to construct the <a class="xref" href="../api/Bonsai.Harp.Timestamped-1.html"><code>Timestamped&lt;T&gt;</code></a> object from another message. In this case, the temporal information will be extracted from the message in the second input. This is most useful when we need to create a timestamped value from a message that already contains a timestamp, for instance, from a Harp Device:</p>
<div class="workflow"><p><img src="../workflows/modify-message-timestamp.bonsai" alt="ModifyHarpMessageTimestamp"></p>
</div>
<h2 id="accessing-the-message-timestamp">Accessing the message timestamp</h2>
<p>The <code>Payload</code> portion of a Harp message can contain information about the hardware timestamp of the message as given by the device. To access this information, we can use the <a class="xref" href="../api/Bonsai.Harp.Parse.html"><code>Parse</code></a> operator as discussed previously. In its simplest form, the core <a class="xref" href="../api/Bonsai.Harp.Parse.html"><code>Parse</code></a> operator can, for any <code>HarpMessage</code>, extract the timestamp information by setting the <a class="xref" href="../api/Bonsai.Harp.ParseMessagePayload.html#Bonsai_Harp_ParseMessagePayload_PayloadType"><code>PayloadType</code></a> property to <code>Timestamp</code>.</p>
<div class="workflow"><p><img src="../workflows/parse-timestamp.bonsai" alt="ParseTimestamp"></p>
</div>
<p>It is important to keep in mind that if a <code>HarpMessage</code> does not contain the optional <code>Timestamp</code> field, the <code>Parse</code> operator will throw an error. We can check if a message has a valid <code>Timestamp</code> field by using the <a class="xref" href="../api/Bonsai.Harp.HarpMessage.html#Bonsai_Harp_HarpMessage_IsTimestamped"><code>IsTimestamped</code></a> property of the <code>HarpMessage</code> class:</p>
<div class="workflow"><p><img src="../workflows/filter-timestamped.bonsai" alt="ParseTimestamp"></p>
</div>
<div class="WARNING">
<h5>Warning</h5>
<p>When parsing the raw message timestamp, the <code>Parse</code> operator will not parse the <code>Payload</code> data portion of the message. This technique is useful when we are only interested in the <code>Timestamp</code> portion of the message.</p>
</div>
<p>If we are interested in simultaneously parsing the data <em>and</em> timestamp information of a message, for specific registers, the alternative is to select the appropriate <code>Timestamped&lt;Register&gt;</code> value from the <a class="xref" href="../api/Bonsai.Harp.ParseBuilder.html#Bonsai_Harp_ParseBuilder_Register"><code>Register</code></a> property. This pattern is available for both the core <code>Bonsai.Harp</code> package and device-specific packages.</p>
<div class="workflow"><p><img src="../workflows/parse-timestamp-data.bonsai" alt="ParseTimestampData"></p>
</div>
<h2 id="timestamping-generic-data">Timestamping generic data</h2>
<p>The timestamp provided by each <code>HarpMessage</code> is often the result of a device operation and will thus be assigned in hardware. However, it can be very useful to assign hardware timestamps to events that occur in software, on the host side.</p>
<p>For example, we may want to know when a mouse button was pressed in a somewhat meaningful temporal reference relative to the acquired Harp data. Unfortunately, the host PC does not run the same clock synchronization protocol as Harp devices, and we cannot use this clock to timestamp events. However, we can still assign a timestamp to any host event by simply using the timestamp from the latest available message emitted by the board.</p>
<p>Since the round-trip delay between host and device is typically small and with low jitter (less than 5 ms) we can use this strategy to timestamp software events. Furthermore, the result of <a class="xref" href="https://bonsai-rx.org/docs/api/Bonsai.Reactive.WithLatestFrom.html"><code>WithLatestFrom</code></a> can be readily converted into a <a class="xref" href="../api/Bonsai.Harp.Timestamped-1.html"><code>Timestamped&lt;T&gt;</code></a> value using the <a class="xref" href="../api/Bonsai.Harp.CreateTimestamped.html"><code>CreateTimestamped</code></a> operator, as shown below.</p>
<div class="workflow"><p><img src="../workflows/withlatest-timestamp-filtered.bonsai" alt="WithLatestTimestampFiltered"></p>
</div>
<div class="NOTE">
<h5>Note</h5>
<p>Harp devices runs a real-time operating system (RTOS) where event timestamping takes a high priority. The host PC, on the other hand, runs a non-RTOS operating system where event timestamping is not a priority. This strategy is not ideal for high-precision timing applications. Furthermore, in some systems it is possible to observe a larger than expected jitter, so we always recommend benchmarking all timings before using this technique.</p>
</div>
<div class="WARNING">
<h5>Warning</h5>
<p>This strategy rests on the assumption that the host has access to a steady stream of messages from the device. However, while some devices provide high-frequency events (e.g. 1 kHz analog read events from a Behavior board), many other boards can be typically silent. In these cases, the temporal stream will be non-homogenous and with poor resolution, and users should use an alternative strategy.</p>
</div>
<p>An example of an alternative strategy is to request a <code>Read</code> operation from the board for each software event to be timestamped. Since each <code>Read</code> message is also timestamped, this can be assigned to the software event using the following pattern of asynchronous &quot;request-timestamp&quot; strategy.</p>
<div class="workflow"><p><img src="../workflows/timestamp-async.bonsai" alt="AsyncRequestTimestamp"></p>
</div>
<p>Finally, we can also timestamp values from an arbitrary source of seconds, for example from an offline file or from a constant declared in the workflow. This is possible due to specific overloads of the <a class="xref" href="../api/Bonsai.Harp.CreateTimestamped.html"><code>CreateTimestamped</code></a> operator that accept <code>double</code> values as timestamps.</p>
<div class="workflow"><p><img src="../workflows/create-timestamped.bonsai" alt="CreateTimestamped"></p>
</div>
<h2 id="preserving-timestamps-in-processing-pipelines">Preserving timestamps in processing pipelines</h2>
<p>When consuming timestamped messages arriving from a Harp device, we may need to compute some transformation on the incoming data (say a value from the ADC that we might want to convert or scale) while maintaining the original timestamp of the data that gave rise to it.</p>
<p>The <a class="xref" href="../api/Bonsai.Harp.ConvertTimestamped.html"><code>ConvertTimestamped</code></a> operator makes this process easier. This operator takes as input a <a class="xref" href="../api/Bonsai.Harp.Timestamped-1.html"><code>Timestamped&lt;T&gt;</code></a> value, e.g. the result of a <a class="xref" href="../api/Bonsai.Harp.Parse.html"><code>Parse</code></a> operator and allows us to define any necessary conversion logic inside the operator.</p>
<div class="WARNING">
<h5>Warning</h5>
<p>All operators inside the nested <code>ConvertTimestamped</code> operator should be synchronous in nature to ensure that all timestamps are correctly paired with the input data. In other words, the nested operation should behave as a <a href="https://bonsai-rx.org/docs/articles/operators.html"><code>Transform</code></a> operator.</p>
</div>
<p>For example, to manipulate the value of a register, and reassign its original timestamp:</p>
<div class="workflow"><p><img src="../workflows/convert-timestamped.bonsai" alt="ConvertTimestamped"></p>
</div>
<h2 id="creating-messages-with-a-timestamped-payload">Creating messages with a timestamped payload</h2>
<p>So far, we have only covered cases where the timestamp is extracted from an existing <code>HarpMessage</code>. However, in certain cases it might also be useful to create a <code>HarpMessage</code> with a <code>Timestamp</code> in the <code>Payload</code> field. Mirroring its use to generate <code>HarpMessages</code>, <a class="xref" href="../api/Bonsai.Harp.CreateMessage.html"><code>CreateMessage</code></a> can also be used to <em>inject</em> a timestamped. We achieve this by:</p>
<ol>
<li>Setting the <code>PayloadType</code> (or <code>Payload</code>) property to a <code>Timestamped</code> type (e.g. <code>TimestampedU8</code>);</li>
<li>Passing a sequence of <a class="xref" href="../api/Bonsai.Harp.Timestamped-1.html"><code>Timestamped&lt;T&gt;</code></a> values to the operator.</li>
</ol>
<div class="workflow"><p><img src="../workflows/create-message-timestamped.bonsai" alt="CreateMessageTimestamped"></p>
</div>
<p>Similarly, we can use <a class="xref" href="../api/Bonsai.Harp.Format.html"><code>Format</code></a> to simultaneously inject a timestamp in the message payload. To do this we can use the same pattern as above for <a class="xref" href="../api/Bonsai.Harp.CreateMessage.html"><code>CreateMessage</code></a>, but this time we need to make sure that the <code>T</code> type is compatible with the selected <a class="xref" href="../api/Bonsai.Harp.FormatMessagePayload.html#Bonsai_Harp_FormatMessagePayload_PayloadType"><code>PayloadType</code></a> or <a class="xref" href="../api/Bonsai.Harp.FormatBuilder.html#Bonsai_Harp_FormatBuilder_Register"><code>Register</code></a> properties in the <code>Format</code> operator.</p>
<div class="workflow"><p><img src="../workflows/format-timestamped.bonsai" alt="FormatTimestamped"></p>
</div>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/harp-tech/harp-tech.github.io/blob/main/articles\message-manipulation.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>&copy; 2023 harp-tech and Contributors</span> - <span>Licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.</span> - <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
